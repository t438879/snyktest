<template>
  <div class="row detect_page">
    <div class="col-md-12">
      <section class="content bg-style">
        <div class="row">
          <div class="col-md-12">
            <div class="box box-solid box-default">
              <!-- /.box-header -->
              <div class="box-body">
                <h5>
                  <b>
                    <p>&nbsp;
                      <i class="fa fa-circle-o text-blue"></i>&nbsp;项目漏洞检测&nbsp;&nbsp;
                    </p>
                  </b>
                </h5>
                <hr>
                <p>
                  开源项目和第三方组件库为软件开发者提供便利的同时，也存在诸多的安全隐患。许多开源项目和第三方组件存在许多安全漏洞，甚至是高危漏洞，如若用户在使用过程中未将存在的漏洞进行修护，将会承担巨大的安全风险。代码克隆检测系统针对该问题开发了漏洞检测引擎，系统内置第三方组件漏洞库和开源项目漏洞库，通过静态检测的方式，分析检测项目存在的漏洞状况。</p>
              </div>
              <!-- /.box-body -->
            </div>
          </div>
          <!--/.col-->
        </div>
        <!-- Small boxes (Stat box) -->

        <div class="row">
          <!-- ./col -->
          <div class="col-md-3">
            <!-- small box -->
            <div class="small-box bg-red">
              <div class="inner">
                <h3>{{vul_high}}</h3>
                <p>高风险漏洞</p>
              </div>
              <div class="icon">
                <i class="ion ion-pie-graph"></i>
              </div>
              <a class="small-box-footer">漏洞安全等级7到10</a>
            </div>
          </div>

          <!-- ./col -->
          <div class="col-md-3">
            <!-- small box -->
            <div class="small-box bg-yellow">
              <div class="inner">
                <h3>{{vul_mid}}</h3>
                <p>中风险漏洞</p>
              </div>
              <div class="icon">
                <i class="ion ion-person-add"></i>
              </div>
              <a class="small-box-footer">漏洞安全等级4到7</a>
            </div>
          </div>
          <div class="col-md-3">
            <!-- small box -->
            <div class="small-box" style="background-color: #EFE42A;color: white">
              <div class="inner">
                <h3>{{vul_low}}</h3>
                <p>低风险漏洞</p>
              </div>
              <div class="icon">
                <i class="ion ion-stats-bars"></i>
              </div>
              <a class="small-box-footer">漏洞安全等级小于4</a>
            </div>
          </div>
          <!-- ./col -->
          <div class="col-md-3">
            <!-- small box -->
            <div class="small-box bg-blue">
              <div class="inner">
                <h3>{{vul_unknown}}</h3>
                <p>未评级漏洞</p>
              </div>
              <div class="icon">
                <i class="ion ion-pie-graph"></i>
              </div>
              <a class="small-box-footer">漏洞安全等级未评级</a>
            </div>
          </div>
          <!-- ./col -->
        </div>
        <div class="row" v-show="vul_result==true">
          <div class="col-md-12">
            <div class="box box-solid box-default">
              <div class="box-header with-border">
                <p>
                  <b>
                    <i class="fa fa-bomb"></i>&nbsp;&nbsp;组件漏洞风险详情</b>
                </p>
                <div class="box-tools pull-right">
                  <button tyvul_unknownpe="button" class="btn btn-box-tool" data-widget="collapse">
                    <i class="fa fa-minus"></i>
                  </button>
                </div>
              </div>
              <div class="box-body box-profile">
                <el-table :data="cve_vul_list_paged" empty-text="组件均无漏洞">
                  <el-table-column type="expand">
                    <template slot-scope="props">
                      <el-table :data="props.row.vulList" empty-text="该组件无漏洞">
                        <el-table-column type="index"></el-table-column>
                        <el-table-column label="CVE" prop="cve_id" align="left">
                          <template slot-scope="p">
                            <router-link target="_blank" :to="{path:'/vul_detail/'+ p.row.cve_id }">
                              {{p.row.cve_id}}
                            </router-link>
                          </template>
                        </el-table-column>
                        <el-table-column label="等级" prop="level">
                          <template slot-scope="props">
                            <div class="progress-bar progress-bar-success" role="progressbar" style="'width:0%; height: 6px" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" v-show="props.row.level==null"></div>
                            <div class="progress-bar" role="progressbar" :style="'width:' + props.row.level + '%; height: 6px;background-color:#EFE42A'" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" v-show="props.row.level<=4"></div>
                            <div class="progress-bar progress-bar-warning" role="progressbar" :style="'width:' + props.row.level + '%; height: 6px'" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" v-show="props.row.level>4 && props.row.level<=7"></div>
                            <div class="progress-bar progress-bar-danger" role="progressbar" :style="'width:' + props.row.level + '%; height: 6px'" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" v-show="props.row.level>7 && props.row.level<=10"></div>
                          </template>
                        </el-table-column>
                        <el-table-column label="级别" prop="severity" align="left">
                          <template slot-scope="p">
                            {{p.row.severity == null ? "未分级" :
                            $t(p.row.severity)}}
                          </template>
                        </el-table-column>
                      </el-table>
                    </template>
                  </el-table-column>

                  <el-table-column label="组件名称" prop="name">
                  </el-table-column>
                  <el-table-column label="漏洞数量" prop="vulHighNum" align="center">
                    <template slot-scope="prop">
                      <el-tag color="#C33531" class="vul_num">
                        {{prop.row.vulHighNum}}
                      </el-tag>
                      <el-tag color="#EE9201" class="vul_num">
                        {{prop.row.vulMidNum}}
                      </el-tag>
                      <el-tag color="#EFE42A" class="vul_num">
                        {{prop.row.vulLowNum}}
                      </el-tag>
                      <el-tag color="#0073b7" class="vul_num">
                        {{prop.row.vulUnknownNum}}
                      </el-tag>
                    </template>
                  </el-table-column>
                </el-table>

                <el-pagination @current-change="paging" :current-page="currentPage" :page-size=10 :total="cve_vul_list.length" layout="prev, pager, next, total, jumper">
                </el-pagination>
              </div>
              <!-- /.box-body -->
            </div>
          </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="vulModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" style="width:1000px" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span></button>
                <!--                        <h3>漏洞分析&nbsp;&nbsp;</h3>-->
              </div>
              <div class="modal-body">
                <center><h3>{{vul_detail.vul_title}}</h3></center>
                <div class="container ">
                  <div class="container">
                    <!--第一层-->

                    <div class="fl w770">
                      <div class="title_bt w770">
                        <h2 style="width:140px;">漏洞信息详情</h2></div>
                      <div style="height:20px;"></div>
                      <div class="detail_xq w770">
                        <div class="col-md-6">
                          <ul>
                            <li>
                              <span>CVE编号：</span>
                              <a v-bind:href="cve_url" target="_blank" rel="nofollow">{{vul_detail.cve_id}}</a>
                              <input type="hidden" id="formId" name="formId" value="2,017,090,507"/>
                            </li>
                            <li>
                              <span>CNNVD编号：{{vul_detail.cnnvd_id}}</span></li>
                            <li>
                              <span>发布时间：</span>
                              {{vul_detail.published_date}}
                            </li>
                            <li>
                            <li>
                              <span>CVSS漏洞评分：</span>
                              {{vul_detail.level}}
                            </li>
                          </ul>
                        </div>
                        <div class="col-md-6">
                          <ul>
                            <li>
                              <span>危害等级：</span>&nbsp;
                              <a style="color:#4095cc;cursor:pointer;">{{vul_detail.severity}}
                                <img v-show="vul_severity==3" src="../../../../../static/image/jb_4.png" border="0">
                                <img v-show="vul_severity==2" src="../../../../../static/image/jb_3.png" border="0">
                                <img v-show="vul_severity==1" src="../../../../../static/image/jb_2.png" border="0">
                                <img v-show="vul_severity==0" src="../../../../../static/image/jb_1.png" border="0">
                                <br/></a></li>
                            <li>
                              <span>漏洞类型：</span>
                              <span v-for="type in vul_detail.vul_type">
                                                {{type}}&nbsp;
                                            </span></li>
                            <li>
                              <span>更新时间：</span>
                              {{vul_detail.update_date}}
                            <li>
                              <span>评分方式：</span>
                              {{vul_detail.level_method}}
                            </li>
                          </ul>
                        </div>
                        <div class="cb"></div>
                      </div>
                      <div class="d_ldjj">
                        <div class="title_bt">
                          <h2 style="width:100px;">漏洞描述</h2></div>
                        <div style="height:20px;"></div>
                        <p style="text-indent:2em" class="ckwz">
                          {{vul_detail.description}}</p>
                      </div>
                      <div class="d_ldjj w770">
                        <div class="title_bt">
                          <h2 style="width:100px;">漏洞威胁</h2></div>
                        <div style="height:20px;"></div>
                        <div class="col-md-6">
                          <ul>
                            <li>
                              <span>漏洞利用方式：</span>{{vul_detail.access_vector}}
                            </li>
                            <li>
                              <span>漏洞利用复杂度：</span>&nbsp;
                              <!--<a style="color:#4095cc;cursor:pointer;">{{vul_detail.access_complexity}}</a>-->
                              {{vul_detail.access_complexity}}
                            </li>
                            <li>
                              <span>漏洞利用身份验证:</span>&nbsp;{{vul_detail.authentication}}
                            </li>
                          </ul>
                        </div>
                        <div class="col-md-6">
                          <ul>
                            <li>
                              <span>系统保密性影响：</span>{{vul_detail.confidentiality}}
                            </li>
                            <li>
                              <span>系统完整性影响:</span>&nbsp;{{vul_detail.integrity}}
                            </li>
                            <li>
                              <span>系统可用性影响:</span>&nbsp;{{vul_detail.availability}}
                            </li>
                          </ul>
                        </div>
                        <div class="cb"></div>
                      </div>
                      <div class="d_ldjj m_t_20">
                        <div class="title_bt">
                          <h2 style="width:100px;">参考网址</h2></div>
                        <div style="height:20px;"></div>
                        <div v-for="url in vul_detail.reference_data">
                          <a style="text-indent:2em;width: 890px;" class="ckwz" v-bind:href="url" target="_blank">{{url}}</a>
                        </div>
                      </div>
                      <div class="d_ldjj">
                        <div class="title_bt">
                          <h2 style="width:120px;">受影响产品</h2></div>
                        <div style="height:20px;"></div>
                        <div v-for="term in vul_detail.impact_products">
                          <p style="text-indent:2em"><a><b>厂商名称：{{term.vender_name}}</b></a>
                          </p>
                          <div class="vulnerability_list">
                            <ul id="ent" v-for="item in term.product_info">
                              <li>
                                <div class="fl">产品：{{item.product_name}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
                                <div style="width:600px;overflow: hidden; white-space:nowrap;text-overflow:ellipsis;" v-bind:title="item.version_list">
                                  版本：<span v-if="item.version_list.length > 1">{{item.version_list}}</span>
                                  <span v-if="item.version_list.length == 1">{{item.version_list[0]}}</span>
                                </div>
                              </li>
                            </ul>
                          </div>
                          <br>
                        </div>
                      </div>
                      <div class="d_ldjj">
                        <div class="title_bt">
                          <h2 style="width:200px;">漏洞补丁参考链接</h2></div>
                        <div style="height:20px;"></div>
                        <div v-for="suggestion in vul_detail.suggestion">
                          <p style="text-indent:2em" class="ckwz">
                            {{suggestion}}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!--主体结束-->
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">
                  确定
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="box  box-solid box-default" v-show="vul_result==false">
          <div class="box-body">
            <h4>检测项目中未发现使用任何安全漏洞！</h4>
          </div>
        </div>
        <div style="height:350px;" v-show="vul_result==false"></div>
      </section>
    </div>
  </div>
</template>
<script>
  import {
    getTaskID,
  } from '../../../style/js/result/util.js';

  export default {

    data: function () {
      return {
        task_id: '',

        //漏洞统计
        vul_low: 0,
        vul_mid: 0,
        vul_high: 0,
        vul_unknown: 0,

        //组件包含漏洞列表
        vul_component: [],
        vul_component_paged: [],
        currentPage2: 1,
        vul_detailInfo: [],

        //cve漏洞详细统计表格
        cve_vul_list: [],
        cve_vul_list_paged: [],
        currentPage: 1,

        //漏洞详情
        vul_detail: [],

        //判断是否显示漏洞图表
        vul_result: true,
        cve_url: '',
        vul_severity: 0,
        radio: "bestMatch",
      }
    },

    mounted: function () {
      // 图形相关
      this.task_id = this.$route.params.id;
      this.getVulList();
    },

    methods: {
      getVulList() {
        this.$http.get("/api/task/vul?taskId=" + this.task_id).then(response => {
          this.cve_vul_list = response.data;

          this.cve_vul_list.forEach(function (item) {
            this.vul_low += item.vulLowNum;
            this.vul_mid += item.vulMidNum;
            this.vul_high += item.vulHighNum;
            this.vul_unknown += item.vulUnknownNum;
          }.bind(this))
        });
      },

      getDetail(cve_id, url) {
        var vm = this;
        vm.cve_url = "http://cve.mitre.org/cgi-bin/cvename.cgi?name=" + cve_id;
        this.$http.get("/api/vul/cve/" + this.task_id + '/' + cve_id).then(response => {
          this.vul_detail = response.data;

          //判断漏洞的危险等级高、中、低
          if (this.vul_detail.severity == "HIGH") {
            this.vul_severity = 3;
            //console.log("vul_severity:" + vm.vul_severity);
          } else if (this.vul_detail.severity == "MEDIUM") {
            this.vul_severity = 2;
          } else if (this.vul_detail.severity == "LOW") {
            this.vul_severity = 1;
          }
        });
      },

      paging: function (currentPage) {
        this.currentPage = currentPage;
        this.cve_vul_list_paged = [];
        let start = (this.currentPage - 1) * 10;
        let end = start + 10;
        if (end > this.cve_vul_list.length) {
          end = this.cve_vul_list.length;
        }
        for (let i = start; i < end; i++) {
          this.cve_vul_list_paged.push(this.cve_vul_list[i]);
        }
      }
    },

    watch: {
      cve_vul_list: function () {
        this.paging(1);
      },

      vul_component: function () {
        this.paging2(1);
      },

      vul_detailInfo: function (val) {
        var vm = this;
        //console.log(val);
        vm.vul_detail = val[0];
        //判断漏洞的危险等级高、中、低
        if (val[0].severity == "HIGH") {
          vm.vul_severity = 3;
          //console.log("vul_severity:" + vm.vul_severity);
        } else if (val[0].severity == "MEDIUM") {
          vm.vul_severity = 2;
        } else if (val[0].severity == "LOW") {
          vm.vul_severity = 1;
        }
      },

      radio: function (val) {
        var vm = this;
        if (val == "cveLevel") {
          var array = vm.cve_vul_list;
          for (var unfix = array.length - 1; unfix > 0; unfix--) {
            /*给进度做个记录，比到未确定位置*/
            for (var i = 0; i < unfix; i++) {
              if (array[i].level < array[i + 1].level) {
                var temp = array[i];
                array.splice(i, 1, array[i + 1]);
                array.splice(i + 1, 1, temp);
              }
            }
          }
          vm.common_component_list = array;
        }
        else if (val == "bestMatch") {
          var array = vm.cve_vul_list;
          vm.cve_vul_list = array;
        }
        else if (val == "cveId") {
          var array = vm.cve_vul_list;
          for (var unfix = array.length - 1; unfix > 0; unfix--) {
            /*给进度做个记录，比到未确定位置*/
            for (var i = 0; i < unfix; i++) {
              if (array[i].cve_id < array[i + 1].cve_id) {
                var temp = array[i];
                array.splice(i, 1, array[i + 1]);
                array.splice(i + 1, 1, temp);
              }
            }
          }
          vm.cve_vul_list = array;
        }

        this.paging(1);
      }
    }
  }

</script>

<style>
  .vul_num {
    margin-right: 3px;
    color: white;
  }
</style>
